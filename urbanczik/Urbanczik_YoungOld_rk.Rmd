---
title: "Younger vs older adults"
author: "Gianna Urbanczik"
date: "2023-09-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

# 1) Desciption of the data
This is data from a study on pronoun processing. We tested younger and older adults. The data here is the off-line data from a visual world eye-tracking experiment, where participants were asked to listen to sentences and to select one out of four visually presented items. We want to compare the performance of the two age groups.

# 2) Description of the variables
## Variables of primary interest
• RT: The latency of the button press (i.e., response) since the offset of the critical stimulus.
• log_RT: Same as RT, but log-transformed.
• Group: Age group (1 for younger adults and 2 for older adults)
• Correct: Accuracy of response (0 for incorrect, 1 for correct)
• Selected: The item type selected (four levels: TARGET, Possessee_comp, Possessor_comp, Distractor)


## Variables of secondary interest
• Trial: Trial number (1 to 104) - may be used to check for effects of order
• List: Pseudo-randomized experimental list (1, 2, 3 or 4)
• Subj_ID: Participant ID
• TaskWAV: Stimulus


# Load data
```{r}
dataYO <- read.csv("data/data_YoungerVsOlder_GU.csv")
```


# 3) Summary statistics
## Response times (RTs)
### Overall RTs
```{r}
mean(dataYO$RT)
median(dataYO$RT)

sd(dataYO$RT)

range(dataYO$RT)
```

### RTs of younger group
```{r}
mean(subset(dataYO, Group == 1)$RT)
median(subset(dataYO, Group == 1)$RT)

sd(subset(dataYO, Group == 1)$RT)

range(subset(dataYO, Group == 1)$RT)
```

### RTs of older group
```{r}
mean(subset(dataYO, Group == 2)$RT)
median(subset(dataYO, Group == 2)$RT)

sd(subset(dataYO, Group == 2)$RT)

range(subset(dataYO, Group == 2)$RT)
```
## Accuracy
### Overall accuracy
```{r}
mean(dataYO$Correct) # percentage of correct responses

sd(dataYO$Correct)
```

### Accuracy of younger adults
```{r}
mean(subset(dataYO, Group == 1)$Correct) # percentage of correct responses

sd(subset(dataYO, Group == 1)$Correct)
```

### Accuracy of older adults
```{r}
mean(subset(dataYO, Group == 2)$Correct) # percentage of correct responses

sd(subset(dataYO, Group == 2)$Correct)
```

## Response type
```{r}
getMode <- function(x) {
   uniqx <- unique(x)
   uniqx[which.max(tabulate(match(x, uniqx)))]
}
```

```{r}
getMode(subset(dataYO, Selected != "TARGET")$Selected)

getMode(subset(dataYO, Selected != "TARGET" & Group == 1)$Selected)

getMode(subset(dataYO, Selected != "TARGET" & Group == 2)$Selected)
```
The summary statistics of the response accuracy show that both participant groups perform near ceiling. Thus, further analysis is obsolete. Given the small number of incorrect responses, a further analysis of response type is likewise unnecessary.




# 4) Models
```{r}
library(lme4)
```

## RT model

```{r}
mdl_RT <- lmer(log_RT ~
                  Group + 
                  (1 | TaskWAV) +
                  (1 + Group | Subj_ID),
               data = dataYO)
```


## Modified model (RK)

The convergence problem might be a false positive. With the default specification; see below:` REML=FALSE` `control = lmerControl(calc.derivs=FALSE)`,  the LMM does not have a convergence problem. Indeed, the model looks fine by the usual quality checks (not singular, VCs supported by data), but your set-up is not really very well suited for an LMM.

```{r}
str(dataYO)
```

Variables must/should have the appropriate type assigned.

+ `Subj_ID `should be a factor
+ `TaskWAV` should be a factor
+ `Group` is usually also specified as a factor and assigned a contrast. In this case it actually helps you, because you can estimate the zero-correlation parameter LMM without converting it to an indicator variable.
+  Ten subjects is normally not a large enough sample.

However, the specification of the RES is not correct. 

+ `Group` is a between-subject variable. Therefore, you cannot estimate a within-subject effect of age. `Group` must not be included as a VC for `Subj_ID`.
+  `Task` is a within-TaskWAV variable. Therefore, you cannot estimate a within-TaskWAV effect of age. `Group` could included as a VC for `TaskWAV`.

The following might be a way to analyze these data. I also change the variable names to my default style. (This is not necessary, but convenient to achieve some comparability across projects.)

```{r}
dat <- 
  dataYO |> 
  as_tibble() |> 
  mutate(Subj = as_factor(Subj_ID),
         Item = as_factor(TaskWAV),
         rt = RT,
         Group = factor(Group, labels=c("young", "old"))) |> 
  select(Subj, Item, Group, rt)

contrasts(dat$Group) <- (-1)*contr.sum(2) 
# We expect fast times for young. To get positive estimate we flip the sign.
     
# check distribution: log-transform is suggested
MASS::boxcox(rt ~ 1 + Group + Subj, data = dat)

m_cpx <- lmer(log(rt) ~ Group + (1 + Group | Item) + (1 | Subj),
               data = dat, REML=FALSE,  control = lmerControl(calc.derivs = FALSE))
isSingular(m_cpx)      # not ok
summary(rePCA(m_cpx))  # not ok
VarCorr(m_cpx)
```

The CP is -1.0. This means `m1` is overparameterized

```{r}
mm <- model.matrix(~ 1 + Group, data = dat)
dat$grp <-  mm[, 2]

m_zcp <- lmer(log(rt) ~ Group + (1 + grp || Item) + (1 | Subj),
               data = dat, REML=FALSE,  control = lmerControl(calc.derivs = FALSE))
isSingular(m_zcp)      # not ok
summary(rePCA(m_zcp))  # not ok
VarCorr(m_zcp)

```

The Item-related VC for the age effect is not supported by the data. 

We are left with varying intercepts.

```{r}
m_ovi <- lmer(log(rt) ~ Group + (1 | Item) + (1 | Subj),
               data = dat, REML=FALSE,  control = lmerControl(calc.derivs = FALSE))
isSingular(m_ovi)      # not ok
summary(rePCA(m_ovi))  # not ok
VarCorr(m_ovi)

anova(m_ovi, m_zcp, m_cpx)

print(summary(m_ovi), cor=FALSE)
```

This LMM `m_ovi` is probably supported by the data. 

Data frame for input to Julia.

```{r}
library(arrow)
write_feather(dat, "data/Urbanczik_YoungOld.arrow")
```

# 5) Analysis and modeling issues
• Specification of random-effect structure supported by data
• Model selection
• Power statistics

RK: We will cover these topics in SMLP2023,